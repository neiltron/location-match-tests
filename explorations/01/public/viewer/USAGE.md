# Viewer3D Usage Guide

## Overview

`Viewer3D` is a Three.js-based viewer for displaying 3D point cloud models generated by VGGT. It provides a complete scene setup with lighting, camera controls, and GLB model loading capabilities.

## Basic Usage

### 1. Import the Viewer

```javascript
import { Viewer3D } from './viewer/Viewer3D.js';
```

### 2. Initialize the Viewer

```javascript
const container = document.getElementById('viewerContainer');
const viewer = new Viewer3D(container, {
  showGrid: true,           // Show 10x10 grid helper
  showAxes: true,           // Show RGB axes (X=red, Y=green, Z=blue)
  backgroundColor: 0x1a1a1a, // Dark grey background
  enableShadows: true       // Enable shadow rendering
});
```

### 3. Load a GLB Model

```javascript
try {
  await viewer.loadGLB('/path/to/model.glb');
  console.log('Model loaded successfully!');
} catch (error) {
  console.error('Failed to load model:', error);
}
```

### 4. Clean Up When Done

```javascript
viewer.dispose();
```

## API Reference

### Constructor

```typescript
new Viewer3D(container: HTMLElement, options?: Viewer3DOptions)
```

**Options:**
- `showGrid?: boolean` - Show ground grid (default: `true`)
- `showAxes?: boolean` - Show coordinate axes (default: `true`)
- `backgroundColor?: number` - Scene background color (default: `0x1a1a1a`)
- `enableShadows?: boolean` - Enable shadow rendering (default: `true`)

### Methods

#### `async loadGLB(url: string): Promise<void>`
Load a GLB/GLTF model from a URL. Automatically centers the model and fits the camera to view it.

```javascript
await viewer.loadGLB('https://example.com/model.glb');
```

#### `clearScene(): void`
Remove the current model from the scene and dispose of its resources.

```javascript
viewer.clearScene();
```

#### `getCamera(): THREE.PerspectiveCamera`
Get the camera instance for external animations (e.g., with GSAP).

```javascript
import gsap from 'gsap';

const camera = viewer.getCamera();
gsap.to(camera.position, {
  x: 10,
  y: 10,
  z: 10,
  duration: 2,
  ease: 'power2.inOut'
});
```

#### `getControls(): OrbitControls`
Get the OrbitControls instance.

```javascript
const controls = viewer.getControls();
controls.autoRotate = true;
```

#### `getCurrentModel(): THREE.Group | null`
Get the currently loaded model.

```javascript
const model = viewer.getCurrentModel();
if (model) {
  console.log('Model is loaded');
}
```

#### `render(): void`
Manually trigger a render (useful if animation loop is paused).

```javascript
viewer.render();
```

#### `resetCamera(): void`
Reset camera to default position or fit to current model.

```javascript
viewer.resetCamera();
```

#### `toggleGrid(visible: boolean): void`
Show or hide the ground grid.

```javascript
viewer.toggleGrid(false); // Hide grid
```

#### `toggleAxes(visible: boolean): void`
Show or hide the coordinate axes.

```javascript
viewer.toggleAxes(false); // Hide axes
```

#### `dispose(): void`
Clean up all resources (geometries, materials, renderer, etc.).

```javascript
viewer.dispose();
```

## Integration Examples

### Example 1: Simple Viewer

```javascript
import { Viewer3D } from './viewer/Viewer3D.js';

const container = document.getElementById('viewer');
const viewer = new Viewer3D(container);

// Load model from button click
document.getElementById('loadBtn').addEventListener('click', async () => {
  const url = document.getElementById('modelUrl').value;
  try {
    await viewer.loadGLB(url);
  } catch (error) {
    alert('Failed to load model: ' + error.message);
  }
});
```

### Example 2: With GSAP Camera Animation

```javascript
import { Viewer3D } from './viewer/Viewer3D.js';
import gsap from 'gsap';

const viewer = new Viewer3D(document.getElementById('viewer'));

await viewer.loadGLB('/model.glb');

// Animate camera on button click
document.getElementById('animateBtn').addEventListener('click', () => {
  const camera = viewer.getCamera();
  const controls = viewer.getControls();

  gsap.to(camera.position, {
    x: 10,
    y: 15,
    z: 10,
    duration: 2,
    ease: 'power2.inOut',
    onUpdate: () => {
      camera.lookAt(controls.target);
    }
  });
});
```

### Example 3: Multiple Models with Switching

```javascript
import { Viewer3D } from './viewer/Viewer3D.js';

const viewer = new Viewer3D(document.getElementById('viewer'));

const models = [
  '/model1.glb',
  '/model2.glb',
  '/model3.glb'
];

let currentIndex = 0;

document.getElementById('nextBtn').addEventListener('click', async () => {
  currentIndex = (currentIndex + 1) % models.length;
  await viewer.loadGLB(models[currentIndex]);
});

document.getElementById('prevBtn').addEventListener('click', async () => {
  currentIndex = (currentIndex - 1 + models.length) % models.length;
  await viewer.loadGLB(models[currentIndex]);
});
```

### Example 4: Integration with VGGT Explorer App

```javascript
// In app.js or app.ts
import { Viewer3D } from './viewer/Viewer3D.js';

class VGGTExplorer {
  constructor() {
    this.viewer = null;
    this.initViewer();
  }

  initViewer() {
    const container = document.getElementById('viewerContainer');
    this.viewer = new Viewer3D(container, {
      showGrid: true,
      showAxes: true,
      backgroundColor: 0x1a1a1a
    });
  }

  async handleProcessComplete(runId) {
    try {
      // Load the GLB from the VGGT output
      const modelUrl = `/api/runs/${runId}/model.glb`;
      await this.viewer.loadGLB(modelUrl);

      // Optional: Animate camera
      this.animateCameraEntry();
    } catch (error) {
      console.error('Failed to load reconstruction:', error);
    }
  }

  animateCameraEntry() {
    const camera = this.viewer.getCamera();
    const startPos = { x: 20, y: 20, z: 20 };
    const endPos = { x: 5, y: 5, z: 5 };

    camera.position.set(startPos.x, startPos.y, startPos.z);

    gsap.to(camera.position, {
      x: endPos.x,
      y: endPos.y,
      z: endPos.z,
      duration: 2,
      ease: 'power2.out'
    });
  }

  dispose() {
    if (this.viewer) {
      this.viewer.dispose();
    }
  }
}

// Initialize app
const app = new VGGTExplorer();

// Clean up on page unload
window.addEventListener('beforeunload', () => {
  app.dispose();
});
```

## Scene Configuration

### Default Lighting Setup

The viewer includes three lights for optimal point cloud visibility:

1. **Ambient Light** - 0.6 intensity, provides overall illumination
2. **Key Directional Light** - 0.8 intensity at (5, 10, 5), main light source with shadows
3. **Fill Directional Light** - 0.4 intensity at (-5, 5, -5), softer fill from opposite side

### Camera Configuration

- **Field of View:** 60 degrees
- **Initial Position:** (5, 5, 5)
- **Near Plane:** 0.1 (dynamically adjusted based on model size)
- **Far Plane:** 1000 (dynamically adjusted based on model size)

### OrbitControls Configuration

- **Damping:** Enabled with factor 0.05 (smooth camera movement)
- **Screen Space Panning:** Disabled (panning follows world space)
- **Min Distance:** 1 (dynamically adjusted based on model size)
- **Max Distance:** 100 (dynamically adjusted based on model size)
- **Max Polar Angle:** Slightly below horizon to prevent flipping

## Browser Compatibility

The viewer uses modern browser APIs:
- **ES Modules** - Import/Export syntax
- **ResizeObserver** - Responsive rendering
- **requestAnimationFrame** - Smooth animation loop

Supported browsers:
- Chrome/Edge 88+
- Firefox 78+
- Safari 14+

## Performance Tips

1. **Model Size:** Keep GLB files under 50MB for best performance
2. **Shadow Quality:** Disable shadows for large models: `enableShadows: false`
3. **Pixel Ratio:** The viewer limits pixel ratio to 2x to prevent performance issues on high-DPI displays
4. **Memory Management:** Always call `dispose()` when switching between models or unmounting the viewer

## Troubleshooting

### Model doesn't appear
- Check browser console for errors
- Verify GLB file is accessible and valid
- Try opening the model in a GLB viewer (e.g., https://gltf-viewer.donmccurdy.com/)

### Camera is too close/far
- The viewer automatically fits the camera based on model size
- You can manually adjust with: `viewer.resetCamera()`

### Controls don't work
- Ensure the viewer container has non-zero dimensions
- Check that no other elements are blocking pointer events

### Memory issues
- Call `clearScene()` before loading new models
- Call `dispose()` when completely done with the viewer
- Consider reducing shadow map size for lower memory usage

## Testing

A test page is available at `/viewer/test-viewer.html` that demonstrates:
- Viewer initialization
- Camera controls
- Grid/axes toggles
- Model loading
- Scene clearing

Open `http://localhost:3000/viewer/test-viewer.html` to test the viewer.
